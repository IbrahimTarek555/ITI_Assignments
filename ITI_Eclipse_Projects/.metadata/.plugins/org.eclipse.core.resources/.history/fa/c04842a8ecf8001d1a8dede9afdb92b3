#include "STD_TYPES.h"
#include "LIBRARY_interface.h"

#include "DIO_interface.h"
#include "PORT_interface.h"
#include "TIMERS_interface.h"
#include "GIE_interface.h"
#include "ADC_interface.h"
#include "EXTI_interface.h"

#include "CLCD_interface.h"

#include <util/delay.h>

/*
 * Timer0: peiod time = 256 * 1 = 256 us
 * 		   duty cycle = 64 / 256 = 25%
 *
 * Timer1:
 */

void Main_voidReadPWM(void);
void Main_voidICU_HW(void);

uint16 Main_u16Time1 = 0;
uint16 Main_u16Time2 = 0;
uint16 Main_u16Time3 = 0;
uint16 Main_u16Period = 0;
uint16 Main_u16On = 0;
//|| (Main_u16Time3 == 0u)
/*It is the main*/
void main(void)
{
	/*Peripherals Initialization*/
	PORT_voidInit();
	CLCD_voidInit();

	TIMER0_voidInit();
	TIMER0_voidSetCompValue(63);

	/*EXTI*/
	EXTI_voidInit();
	EXTI_u8SetCallBack(EXTI_u8INT0, Main_voidReadPWM);
//	ICU_voidInit();

//	TIMERS_u8SetCallBack(TIMER1_ICU, Main_voidICU_HW);
	TIMER1_voidInit();


	GIE_voidEnable();

		while((Main_u16Time1 == 0u) || (Main_u16Time2 == 0u));

		Main_u16Period = Main_u16Time2;
		Main_u16On = Main_u16Time3 - Main_u16Time2;
		CLCD_voidClearDisplay();
		CLCD_u8GoToXY(0, 0);
		CLCD_voidSendDecimalNumber(Main_u16Period);
		CLCD_u8GoToXY(0, 1);
		CLCD_voidSendDecimalNumber(Main_u16On);
	/*Super Loop*/
	while(1)
	{

	}
}

void Main_voidICU_HW(void)
{
	static uint8 Local_u8counter = 0u;
	Local_u8counter++;

	if(Local_u8counter == 1u)
	{
		Main_u16Time1 = ICU_u16GetInputCaptureValue();

	}
	else if(Local_u8counter == 2u)
	{
		Main_u16Time2 = ICU_u16GetInputCaptureValue();
		ICU_u8SetTriggerSrc(ICU_u8FALLING_EDGE);
	}
	else if(Local_u8counter == 3u)
	{
		Main_u16Time3 = ICU_u16GetInputCaptureValue();
		ICU_voidIntDisable();
	}
}

void Main_voidReadPWM(void)
{
	CLCD_u8GoToXY(0, 0);
	CLCD_u8SendString("hgoah");
	static uint8 Local_u8Counter = 0u;


	if(Local_u8Counter == 2u)
	{
		CLCD_u8GoToXY(0, 0);
		CLCD_u8SendString("hgoah");
		_delay_ms(1000);
		TIMER1_voidSetTimerValue(0u);
	}
	else if(Local_u8Counter == 3u)
	{
		CLCD_u8GoToXY(0, 0);
		CLCD_u8SendString("hhhh");
		_delay_ms(1000);

		Main_u16Time2 = TIMER1_u16GetValue();
		EXTI_u8SetSenseCtrl(EXTI_u8INT0, EXTI_u8FALLING_EDGE);
	}
	else if(Local_u8Counter == 4u)
	{
		CLCD_u8GoToXY(0, 0);
		CLCD_u8SendString("hgofffah");
		_delay_ms(1000);

		Main_u16Time3 = TIMER1_u16GetValue();
		EXTI_u8IntDisable(EXTI_u8INT0);
	}
	Local_u8Counter++;
}
